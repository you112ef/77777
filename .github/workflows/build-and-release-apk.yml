name: ğŸš€ Build and Release Android APK

on:
  push:
    branches: [ main, master ]
    tags: [ 'v*' ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:
    inputs:
      release_type:
        description: 'Release Type'
        required: true
        default: 'debug'
        type: choice
        options:
        - debug
        - release

jobs:
  build-android:
    name: ğŸ“± Build Android APK
    runs-on: ubuntu-latest
    
    strategy:
      matrix:
        api-level: [29]
        target: [default]
        arch: [x86_64]
    
    steps:
    - name: ğŸ“¥ Checkout Repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
    
    - name: ğŸ—ï¸ Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'
        cache-dependency-path: 'sperm-analyzer-mobile/package-lock.json'
    
    - name: â˜• Setup Java JDK
      uses: actions/setup-java@v4
      with:
        java-version: '17'
        distribution: 'temurin'
    
    - name: ğŸ› ï¸ Setup Android SDK
      uses: android-actions/setup-android@v3
      with:
        api-level: 29
        build-tools: '33.0.0'
        cmake: '3.22.1'
        ndk: '25.1.8937393'
    
    - name: ğŸ“¦ Install Dependencies
      working-directory: ./sperm-analyzer-mobile
      run: |
        npm ci
        npm install -g @capacitor/cli
    
    - name: ğŸ”¨ Build Web Assets
      working-directory: ./sperm-analyzer-mobile
      run: |
        npm run build
        npx cap sync android
    
    - name: ğŸ” Create Keystore (Debug)
      working-directory: ./sperm-analyzer-mobile/android
      run: |
        keytool -genkey -v -keystore debug.keystore -alias debug -keyalg RSA -keysize 2048 -validity 10000 \
        -dname "CN=SpermAnalyzer, OU=Medical, O=AI Lab, L=Riyadh, ST=Saudi Arabia, C=SA" \
        -storepass android -keypass android
    
    - name: ğŸ“± Build Debug APK
      working-directory: ./sperm-analyzer-mobile/android
      run: |
        chmod +x gradlew
        ./gradlew assembleDebug
    
    - name: ğŸ“± Build Release APK (if tag)
      if: startsWith(github.ref, 'refs/tags/v')
      working-directory: ./sperm-analyzer-mobile/android
      run: |
        ./gradlew assembleRelease
    
    - name: ğŸ“Š APK Info
      working-directory: ./sperm-analyzer-mobile/android
      run: |
        echo "ğŸ“± APK Build Information:"
        echo "========================"
        ls -la app/build/outputs/apk/debug/ || echo "No debug APK found"
        ls -la app/build/outputs/apk/release/ || echo "No release APK found"
        
        if [ -f "app/build/outputs/apk/debug/app-debug.apk" ]; then
          echo "ğŸ“ Debug APK Size: $(du -h app/build/outputs/apk/debug/app-debug.apk | cut -f1)"
        fi
        
        if [ -f "app/build/outputs/apk/release/app-release-unsigned.apk" ]; then
          echo "ğŸ“ Release APK Size: $(du -h app/build/outputs/apk/release/app-release-unsigned.apk | cut -f1)"
        fi
    
    - name: âœ… Verify APK
      working-directory: ./sperm-analyzer-mobile/android
      run: |
        if [ -f "app/build/outputs/apk/debug/app-debug.apk" ]; then
          aapt dump badging app/build/outputs/apk/debug/app-debug.apk | grep -E "(application-label|package:|versionCode|versionName|platformBuildVersionName)"
        fi
    
    - name: ğŸ“¤ Upload Debug APK
      uses: actions/upload-artifact@v4
      with:
        name: ğŸ§¬ Sperm-Analyzer-AI-Debug-APK
        path: sperm-analyzer-mobile/android/app/build/outputs/apk/debug/app-debug.apk
        retention-days: 30
    
    - name: ğŸ“¤ Upload Release APK (if exists)
      if: startsWith(github.ref, 'refs/tags/v')
      uses: actions/upload-artifact@v4
      with:
        name: ğŸ§¬ Sperm-Analyzer-AI-Release-APK
        path: sperm-analyzer-mobile/android/app/build/outputs/apk/release/app-release-unsigned.apk
        retention-days: 90
    
    - name: ğŸ‰ Create GitHub Release
      if: startsWith(github.ref, 'refs/tags/v')
      uses: softprops/action-gh-release@v1
      with:
        name: ğŸ§¬ Sperm Analyzer AI v${{ github.ref_name }}
        body: |
          # ğŸ§¬ Ù…Ø­Ù„Ù„ Ø§Ù„Ø­ÙŠÙˆØ§Ù†Ø§Øª Ø§Ù„Ù…Ù†ÙˆÙŠØ© Ø¨Ø§Ù„Ø°ÙƒØ§Ø¡ Ø§Ù„Ø§ØµØ·Ù†Ø§Ø¹ÙŠ
          
          ## âœ¨ Ø§Ù„Ù…ÙŠØ²Ø§Øª Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©:
          - ğŸ¯ ØªØ­Ù„ÙŠÙ„ Ø¯Ù‚ÙŠÙ‚ Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… YOLOv8 ÙˆDeepSORT
          - ğŸ“Š Ø±Ø³ÙˆÙ… Ø¨ÙŠØ§Ù†ÙŠØ© ØªÙØ§Ø¹Ù„ÙŠØ© Ø¨Ø§Ù„Ù„ØºØ© Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©
          - ğŸ¥ ØªÙˆØ§ÙÙ‚ Ù…Ø¹ Ù…Ø¹Ø§ÙŠÙŠØ± Ù…Ù†Ø¸Ù…Ø© Ø§Ù„ØµØ­Ø© Ø§Ù„Ø¹Ø§Ù„Ù…ÙŠØ© (WHO 2010)
          - ğŸ“± ÙŠØ¹Ù…Ù„ 100% Ø¨Ø¯ÙˆÙ† Ø¥Ù†ØªØ±Ù†Øª
          - ğŸ“¤ ØªØµØ¯ÙŠØ± Ø§Ù„Ù†ØªØ§Ø¦Ø¬ Ø¨ØµÙŠØº Ù…ØªØ¹Ø¯Ø¯Ø© (PDF, CSV, JSON)
          - ğŸ“· Ø§Ù„ØªÙ‚Ø§Ø· Ù…Ù† Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§ Ø£Ùˆ Ø§Ø®ØªÙŠØ§Ø± Ù…Ù† Ø§Ù„Ù…Ø¹Ø±Ø¶
          
          ## ğŸ“± ÙƒÙŠÙÙŠØ© Ø§Ù„ØªØ«Ø¨ÙŠØª:
          1. Ø­Ù…Ù‘Ù„ Ù…Ù„Ù APK Ù…Ù† Ø§Ù„Ø£Ø³ÙÙ„
          2. ÙØ¹Ù‘Ù„ "Ù…ØµØ§Ø¯Ø± ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙØ©" ÙÙŠ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø£Ù…Ø§Ù†
          3. Ø«Ø¨Ù‘Øª Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ ÙˆØ§Ø³ØªÙ…ØªØ¹!
          
          ## âš ï¸ ØªÙ†Ø¨ÙŠÙ‡ Ø·Ø¨ÙŠ:
          Ù‡Ø°Ø§ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ Ù„Ù„Ø£ØºØ±Ø§Ø¶ Ø§Ù„ØªØ¹Ù„ÙŠÙ…ÙŠØ© ÙˆØ§Ù„Ø¨Ø­Ø«ÙŠØ© ÙÙ‚Ø·. ÙŠÙÙ†ØµØ­ Ø¨Ù…Ø±Ø§Ø¬Ø¹Ø© Ø·Ø¨ÙŠØ¨ Ù…Ø®ØªØµ Ù„Ù„ØªØ´Ø®ÙŠØµ Ø§Ù„Ø·Ø¨ÙŠ.
          
          ---
          
          # ğŸ§¬ Sperm Analyzer AI (English)
          
          ## âœ¨ New Features:
          - ğŸ¯ Accurate analysis using YOLOv8 and DeepSORT
          - ğŸ“Š Interactive charts in Arabic
          - ğŸ¥ WHO 2010 compliant analysis
          - ğŸ“± 100% offline functionality
          - ğŸ“¤ Multi-format export (PDF, CSV, JSON)
          - ğŸ“· Camera capture or gallery selection
          
          Built with â¤ï¸ using AI and modern web technologies.
        files: |
          sperm-analyzer-mobile/android/app/build/outputs/apk/debug/app-debug.apk
          sperm-analyzer-mobile/android/app/build/outputs/apk/release/app-release-unsigned.apk
        draft: false
        prerelease: false
        generate_release_notes: true
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  security-scan:
    name: ğŸ”’ Security Scan
    runs-on: ubuntu-latest
    needs: build-android
    
    steps:
    - name: ğŸ“¥ Checkout Repository
      uses: actions/checkout@v4
    
    - name: ğŸ” Run CodeQL Analysis
      uses: github/codeql-action/init@v3
      with:
        languages: javascript
    
    - name: ğŸ” Perform CodeQL Analysis
      uses: github/codeql-action/analyze@v3

  notify:
    name: ğŸ“¢ Notify Build Status
    runs-on: ubuntu-latest
    needs: [build-android, security-scan]
    if: always()
    
    steps:
    - name: ğŸ‰ Success Notification
      if: needs.build-android.result == 'success'
      run: |
        echo "âœ… APK ØªÙ… Ø¨Ù†Ø§Ø¤Ù‡ Ø¨Ù†Ø¬Ø§Ø­!"
        echo "ğŸ”— ÙŠÙ…ÙƒÙ†Ùƒ ØªØ­Ù…ÙŠÙ„ APK Ù…Ù† artifacts Ø£Ùˆ releases"
        echo "ğŸ“± Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ Ø¬Ø§Ù‡Ø² Ù„Ù„Ø§Ø³ØªØ®Ø¯Ø§Ù…!"
    
    - name: âŒ Failure Notification
      if: needs.build-android.result == 'failure'
      run: |
        echo "âŒ ÙØ´Ù„ ÙÙŠ Ø¨Ù†Ø§Ø¡ APK"
        echo "ğŸ” ØªØ­Ù‚Ù‚ Ù…Ù† logs Ù„Ù„ØªÙØ§ØµÙŠÙ„"